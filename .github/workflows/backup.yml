name: Supa-backup

on:
  workflow_dispatch: 
jobs:   
  run_db_backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      supabase_db_url: ${{ secrets.SUPABASE_DB_URL }}   # For example: postgresql://postgres:[YOUR-PASSWORD]@db.<ref>.supabase.co:5432/postgres
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Clone data
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "Cloning..."
          git clone --depth=1 https://x-access-token:${GH_TOKEN}@github.com/tachib-akiko/cuutruyen-data.git data
          echo "âœ… Clone done."
          
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Backup roles
        working-directory: data
        run: supabase db dump --db-url "$supabase_db_url" -f roles.sql --role-only

      - name: Backup schema
        working-directory: data
        run: supabase db dump --db-url "$supabase_db_url" -f schema.sql

      - name: Backup data
        working-directory: data
        run: supabase db dump --db-url "$supabase_db_url" -f data.sql --data-only --use-copy

      - name: Generate timestamp
        id: timestamp
        working-directory: data
        run: echo "BACKUP_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV

      - name: Commit and push backup
        working-directory: data
        run: |
          git checkout -B main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all changes in the data directory
          
          git add .
          

          git push origin main
